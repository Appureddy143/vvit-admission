<?php
/**
 * ===================================================================
 * SIMPLE FRONT CONTROLLER / ROUTER
 * ===================================================================
 * All requests are routed here by Apache’s FallbackResource directive.
 */

// Get the requested URL path
$request_uri = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH);

// --- ROUTING LOGIC ---
if (str_starts_with($request_uri, '/admin')) {
    require 'admin.php';
    exit;
}

// Continue to registration page for all other routes
require_once 'db.php';

// --- Helper Functions ---
function generateUniqueCode($pdo) {
    $collegeCode = "1VJ";
    $year = date("y");

    $time_json = @file_get_contents('http://worldtimeapi.org/api/timezone/Asia/Kolkata');
    if ($time_json !== false) {
        $time_data = json_decode($time_json, true);
        if (isset($time_data['utc_datetime'])) {
            $year = date("y", strtotime($time_data['utc_datetime']));
        }
    }

    $branch = $_POST['allotted_branch_kea'] ?? $_POST['allotted_branch_management'] ?? 'GEN';
    $branch = strtoupper(htmlspecialchars($branch, ENT_QUOTES, 'UTF-8'));
    $prefix = $collegeCode . $year . $branch;

    $stmt = $pdo->prepare("SELECT student_id_text FROM students WHERE student_id_text LIKE ? ORDER BY id DESC LIMIT 1");
    $stmt->execute([$prefix . '%']);
    $lastIdRow = $stmt->fetch(PDO::FETCH_ASSOC);

    $newNum = "001";
    if ($lastIdRow) {
        $lastNum = intval(substr($lastIdRow['student_id_text'], -3));
        $newNum = str_pad($lastNum + 1, 3, '0', STR_PAD_LEFT);
    }

    return $prefix . $newNum;
}

// --- Handle Form Submission ---
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $sanitized_post = [];
    foreach ($_POST as $key => $value) {
        $sanitized_post[$key] = htmlspecialchars($value, ENT_QUOTES, 'UTF-8');
    }

    if (empty($sanitized_post['student_name']) || empty($sanitized_post['email'])) {
        die("Error: Student Name and Email are required fields.");
    }

    $studentId = generateUniqueCode($pdo);

    $uploadDir = 'uploads/';
    if (!is_dir($uploadDir)) {
        mkdir($uploadDir, 0755, true);
    }

    $fileUrls = [];
    foreach ($_FILES as $key => $file) {
        if (isset($file['error']) && $file['error'] === UPLOAD_ERR_OK) {
            $fileExtension = pathinfo($file['name'], PATHINFO_EXTENSION);
            $newFilename = $studentId . '_' . $key . '.' . $fileExtension;
            $targetPath = $uploadDir . $newFilename;

            if (move_uploaded_file($file['tmp_name'], $targetPath)) {
                $fileUrls[$key . '_url'] = $targetPath;
            }
        }
    }

    $dataToSave = array_merge($sanitized_post, $fileUrls, ['student_id_text' => $studentId]);

    try {
        $columns = array_keys($dataToSave);
        $filtered_columns = array_filter($columns, fn($col) => preg_match('/^[a-zA-Z0-9_]+$/', $col));
        $placeholders = array_map(fn($c) => ":$c", $filtered_columns);

        $sql = sprintf(
            'INSERT INTO students (%s) VALUES (%s)',
            implode(', ', $filtered_columns),
            implode(', ', $placeholders)
        );
        $stmt = $pdo->prepare($sql);

        foreach ($filtered_columns as $column) {
            $stmt->bindValue(":$column", $dataToSave[$column]);
        }

        $stmt->execute();

        $whatsapp_number = preg_replace('/[^0-9]/', '', $sanitized_post['mobile_number']);
        if (strlen($whatsapp_number) == 10) {
            $whatsapp_number = '91' . $whatsapp_number;
        }
        $whatsapp_message = urlencode("Thank you for registering with Vijay Vittal Institute of Technology. Your Admission ID is: " . $studentId);
        $whatsapp_url = "https://wa.me/" . $whatsapp_number . "?text=" . $whatsapp_message;

        echo <<<HTML
        <style>
            body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: linear-gradient(rgba(43, 45, 66, 0.7), rgba(43, 45, 66, 0.7)), url('https://i.pinimg.com/736x/5f/b9/14/5fb91492c_85a32312f4717cc5200b359.jpg'); background-size: cover; background-position: center; min-height: 100vh; display: flex; justify-content: center; align-items: center; }
            .success-modal { max-width: 500px; background: rgba(237, 242, 244, 0.95); border-radius: 15px; padding: 40px; text-align: center; box-shadow: 0 4px 30px rgba(0,0,0,0.1); }
            .success-modal h2 { color: #2b2d42; }
            .admission-id { font-size: 1.5em; font-weight: bold; color: #d90429; background: #fff; padding: 10px 20px; border-radius: 5px; display: inline-block; margin: 10px 0; border: 1px solid #ddd; }
            .btn-group { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
            .btn { padding: 12px 25px; color: white; border-radius: 8px; text-decoration: none; font-weight: bold; border: none; cursor: pointer; }
            .whatsapp-btn { background-color: #25D366; }
            .copy-btn { background-color: #8d99ae; }
            .finish-btn { background-color: #2b2d42; }
        </style>
        <div class="success-modal">
            <h2>✅ Success!</h2>
            <p>Your application has been submitted successfully.</p>
            <p>Your Admission ID is:</p>
            <div id="admissionId" class="admission-id">{$studentId}</div>
            <div class="btn-group">
                <a href="{$whatsapp_url}" target="_blank" class="btn whatsapp-btn">Send to WhatsApp</a>
                <button id="copyBtn" class="btn copy-btn">Copy ID</button>
                <button onclick="window.location.href='/'" class="btn finish-btn">Finish</button>
            </div>
            <p>Please save this ID for future reference.</p>
        </div>
        <script>
            document.getElementById('copyBtn').addEventListener('click', function() {
                navigator.clipboard.writeText('{$studentId}').then(() => alert('Admission ID copied!'));
            });
        </script>
HTML;

    } catch (PDOException $e) {
        die("Database error: " . $e->getMessage());
    }
    exit;
}

?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vijay Vittal - Student Registration</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cedarville+Cursive&display=swap');
        :root {
            --space-cadet: #2b2d42;
            --cool-gray: #8d99ae;
            --antiflash-white: #edf2f4;
            --red-pantone: #ef233c;
            --fire-engine-red: #d90429;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0; padding: 20px;
            background: linear-gradient(rgba(43,45,66,0.7), rgba(43,45,66,0.7)),
                        url('https://i.pinimg.com/736x/5f/b9/14/5fb91492c85a32312f4717cc5200b359.jpg');
            background-size: cover;
            background-position: center;
            min-height: 100vh;
        }
        .container {
            max-width: 700px; margin: 20px auto;
            background: rgba(141,153,174,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(141,153,174,0.2);
            box-shadow: 0 4px 30px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .animated-title {
            font-family: 'Cedarville Cursive', cursive;
            font-size: 2.5em;
            text-align: center;
            color: var(--antiflash-white);
            white-space: nowrap;
            overflow: hidden;
            border-right: .15em solid var(--red-pantone);
            width: 0;
            animation: typing 3.5s steps(40,end) forwards, blink-caret .75s step-end infinite;
        }
        @keyframes typing { from { width: 0 } to { width: 100% } }
        @keyframes blink-caret { 50% { border-color: transparent } }
        label, fieldset legend { color: var(--antiflash-white); font-weight: 600; }
        input, select, textarea {
            width: 100%; padding: 12px; margin-bottom: 20px;
            background: rgba(43,45,66,0.5); color: var(--antiflash-white);
            border: 1px solid var(--cool-gray); border-radius: 5px;
        }
        button[type="submit"] {
            width: 100%; padding: 15px;
            background-color: var(--fire-engine-red);
            color: var(--antiflash-white);
            border: none; border-radius: 5px;
            font-size: 18px; font-weight: bold;
            cursor: pointer;
        }
        button[type="submit"]:hover { background-color: var(--red-pantone); }
        .hidden { display: none; }

        /* Floating Admin Button */
        .floating-admin-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #ef233c;
            color: white;
            padding: 12px 18px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: background-color 0.3s, transform 0.2s;
            z-index: 1000;
        }
        .floating-admin-btn:hover {
            background-color: #d90429;
            transform: scale(1.05);
        }
    </style>
</head>
<body>

   <a href="/admin.php" class="header-btn">Admin Panel</a>

    <div class="container">
        <h1 class="animated-title">Vijay Vittal Institute of Technology</h1>
        <h2 style="text-align:center;color:white;">Student Registration</h2>

        <!-- Registration Form -->
        <form action="/" method="POST" enctype="multipart/form-data">
            <!-- Student Details -->
            <label for="student_name">Student Name</label>
            <input type="text" id="student_name" name="student_name" required>

            <label for="dob">Date of Birth</label>
            <input type="date" id="dob" name="dob" required>

            <label for="father_name">Father's Name</label>
            <input type="text" id="father_name" name="father_name" required>

            <label for="mother_name">Mother's Name</label>
            <input type="text" id="mother_name" name="mother_name" required>

            <label for="mobile_number">Mobile Number</label>
            <input type="tel" id="mobile_number" name="mobile_number" required>

            <label for="parent_mobile_number">Father/Mother/Guardian Mobile Number</label>
            <input type="tel" id="parent_mobile_number" name="parent_mobile_number" required>

            <label for="email">Email Address</label>
            <input type="email" id="email" name="email" required>

            <label for="permanent_address">Permanent Address</label>
            <textarea id="permanent_address" name="permanent_address" rows="3" required></textarea>

            <label for="previous_college">Previous Year College Name</label>
            <input type="text" id="previous_college" name="previous_college" required>

            <label for="previous_combination">Previous Year Combination</label>
            <select id="previous_combination" name="previous_combination" required>
                <option value="">--Select--</option>
                <option value="PCMB">PCMB</option>
                <option value="PCMC">PCMC</option>
                <option value="DIPLOMA">DIPLOMA (Lateral Entry)</option>
            </select>

            <label for="category">Category</label>
            <select id="category" name="category" required>
                <option value="">--Select--</option>
                <option value="CAT 1">CAT 1</option>
                <option value="2A">2A</option>
                <option value="2B">2B</option>
                <option value="3A">3A</option>
                <option value="3B">3B</option>
                <option value="SC">SC</option>
                <option value="ST">ST</option>
                <option value="NOT APPLICABLE">NOT APPLICABLE</option>
            </select>

            <label for="sub_caste">Sub Caste</label>
            <input type="text" id="sub_caste" name="sub_caste" required>

            <fieldset>
                <legend>Admission Through</legend>
                <input type="radio" id="kea" name="admission_through" value="KEA" required>
                <label for="kea">KEA</label>
                <input type="radio" id="management" name="admission_through" value="MANAGEMENT">
                <label for="management">MANAGEMENT</label>
            </fieldset>

            <div id="keaFields" class="hidden">
                <label for="cet_number">CET Number</label>
                <input type="text" id="cet_number" name="cet_number">

                <label for="seat_allotted">Seat Allotted</label>
                <select id="seat_allotted" name="seat_allotted">
                    <option value="">--Select--</option>
                    <option value="SNQ">SNQ</option><option value="GM">GM</option><option value="SC">SC</option>
                    <option value="ST">ST</option><option value="OBC">OBC</option><option value="EWS">EWS</option>
                </select>

                <label for="allotted_branch_kea">Allotted Branch</label>
                <select id="allotted_branch_kea" name="allotted_branch_kea">
                    <option value="">--Select--</option>
                    <option value="CSE">CSE</option>
                    <option value="AIML">AIML</option>
                    <option value="EC">EC</option>
                    <option value="CV">CV</option>
                    <option value="ME">ME</option>
                </select>

                <label for="cet_rank">CET Rank</label>
                <input type="text" id="cet_rank" name="cet_rank">
            </div>

            <div id="managementFields" class="hidden">
                <label for="allotted_branch_management">Directly Allotted Branch</label>
                <select id="allotted_branch_management" name="allotted_branch_management">
                    <option value="">--Select--</option>
                    <option value="CSE">CSE</option>
                    <option value="AIML">AIML</option>
                    <option value="EC">EC</option>
                    <option value="CV">CV</option>
                    <option value="ME">ME</option>
                </select>
            </div>

            <h3 style="color:white;">Document Uploads</h3>

            <label for="photo">Passport Size Photo</label>
            <input type="file" id="photo" name="photo" required>

            <label for="marks_card">Previous Marks Card</label>
            <input type="file" id="marks_card" name="marks_card" required>

            <label for="aadhaar_front">Aadhaar Card (Front)</label>
            <input type="file" id="aadhaar_front" name="aadhaar_front" required>

            <label for="aadhaar_back">Aadhaar Card (Back)</label>
            <input type="file" id="aadhaar_back" name="aadhaar_back" required>

            <label for="caste_income">Caste & Income Certificate (if applicable)</label>
            <input type="file" id="caste_income" name="caste_income">

            <button type="submit">Submit Application</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const keaRadio = document.getElementById('kea');
            const managementRadio = document.getElementById('management');
            const keaFields = document.getElementById('keaFields');
            const managementFields = document.getElementById('managementFields');

            function toggleFields() {
                if (keaRadio.checked) {
                    keaFields.classList.remove('hidden');
                    managementFields.classList.add('hidden');
                } else if (managementRadio.checked) {
                    managementFields.classList.remove('hidden');
                    keaFields.classList.add('hidden');
                }
            }

            keaRadio.addEventListener('change', toggleFields);
            managementRadio.addEventListener('change', toggleFields);
        });
    </script>
</body>
</html>
